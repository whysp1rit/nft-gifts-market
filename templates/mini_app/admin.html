{% extends "mini_app/base.html" %}

{% block title %}–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å - NFT Gifts Market{% endblock %}

{% block content %}
<div class="card">
    <h2 style="margin-bottom: 16px; color: #dc3545;">üîß –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h2>
    <p style="color: var(--tg-theme-hint-color); font-size: 14px;">
        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –±–∞–ª–∞–Ω—Å–∞–º–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    </p>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="card">
    <h3 style="margin-bottom: 12px;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
    <div id="statsContainer">
        <div class="text-center" style="padding: 20px; color: var(--tg-theme-hint-color);">
            ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...
        </div>
    </div>
</div>

<!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
<div class="card">
    <h3 style="margin-bottom: 12px;">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
    
    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div style="margin-bottom: 16px;">
        <button class="btn" onclick="showAddBalanceForm()">
            üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å
        </button>
        <button class="btn btn-secondary" onclick="showUpdateDealsForm()">
            üìà –ù–∞–∫—Ä—É—Ç–∏—Ç—å —Å–¥–µ–ª–∫–∏
        </button>
        <button class="btn btn-secondary" onclick="refreshUsers()">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
        </button>
    </div>
    
    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div id="usersContainer">
        <div class="text-center" style="padding: 20px; color: var(--tg-theme-hint-color);">
            ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ -->
<div id="addBalanceModal" class="hidden">
    <div class="card" style="background: #e3f2fd; border: 1px solid #2196f3;">
        <h4 style="margin-bottom: 16px; color: #1976d2;">üí∞ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h4>
        
        <form id="addBalanceForm">
            <div class="form-group">
                <label class="form-label">Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                <input type="text" class="form-control" id="balanceUserId" required 
                       placeholder="123456789">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div class="form-group">
                    <label class="form-label">–°—É–º–º–∞</label>
                    <input type="number" class="form-control" id="balanceAmount" 
                           step="0.01" min="0.01" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–í–∞–ª—é—Ç–∞</label>
                    <select class="form-select" id="balanceCurrency" required>
                        <option value="stars">‚≠ê –ó–≤–µ–∑–¥—ã</option>
                        <option value="rub">‚ÇΩ –†—É–±–ª–∏</option>
                    </select>
                </div>
            </div>
            
            <div style="display: flex; gap: 8px; margin-top: 16px;">
                <button type="submit" class="btn" style="flex: 1;">
                    ‚úÖ –ü–æ–ø–æ–ª–Ω–∏—Ç—å
                </button>
                <button type="button" class="btn btn-secondary" onclick="hideAddBalanceForm()" style="flex: 1;">
                    ‚ùå –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–∫—Ä—É—Ç–∫–∏ —Å–¥–µ–ª–æ–∫ -->
<div id="updateDealsModal" class="hidden">
    <div class="card" style="background: #f3e5f5; border: 1px solid #9c27b0;">
        <h4 style="margin-bottom: 16px; color: #7b1fa2;">üìà –ù–∞–∫—Ä—É—Ç–∫–∞ —Å–¥–µ–ª–æ–∫</h4>
        
        <form id="updateDealsForm">
            <div class="form-group">
                <label class="form-label">Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                <input type="text" class="form-control" id="dealsUserId" required 
                       placeholder="123456789">
            </div>
            
            <div class="form-group">
                <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</label>
                <input type="number" class="form-control" id="dealsCount" 
                       min="0" value="0" required>
            </div>
            
            <div style="display: flex; gap: 8px; margin-top: 16px;">
                <button type="submit" class="btn" style="flex: 1;">
                    ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                </button>
                <button type="button" class="btn btn-secondary" onclick="hideUpdateDealsForm()" style="flex: 1;">
                    ‚ùå –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </form>
    </div>
</div>

<!-- –®–∞–±–ª–æ–Ω —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
<template id="statsTemplate">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
        <div style="text-align: center; padding: 16px; background: var(--tg-theme-bg-color); border-radius: 8px; border: 1px solid var(--tg-theme-hint-color);">
            <div style="font-size: 20px; font-weight: bold; color: var(--tg-theme-link-color);" data-field="total_users">0</div>
            <div style="font-size: 12px; color: var(--tg-theme-hint-color);">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        </div>
        <div style="text-align: center; padding: 16px; background: var(--tg-theme-bg-color); border-radius: 8px; border: 1px solid var(--tg-theme-hint-color);">
            <div style="font-size: 20px; font-weight: bold; color: #28a745;" data-field="total_deals">0</div>
            <div style="font-size: 12px; color: var(--tg-theme-hint-color);">–°–¥–µ–ª–æ–∫</div>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div style="text-align: center; padding: 16px; background: var(--tg-theme-bg-color); border-radius: 8px; border: 1px solid var(--tg-theme-hint-color);">
            <div style="font-size: 18px; font-weight: bold; color: #ffc107;" data-field="total_stars">‚≠ê 0</div>
            <div style="font-size: 12px; color: var(--tg-theme-hint-color);">–í—Å–µ–≥–æ –∑–≤–µ–∑–¥</div>
        </div>
        <div style="text-align: center; padding: 16px; background: var(--tg-theme-bg-color); border-radius: 8px; border: 1px solid var(--tg-theme-hint-color);">
            <div style="font-size: 18px; font-weight: bold; color: #28a745;" data-field="total_rub">‚ÇΩ 0</div>
            <div style="font-size: 12px; color: var(--tg-theme-hint-color);">–í—Å–µ–≥–æ —Ä—É–±–ª–µ–π</div>
        </div>
    </div>
</template>

<!-- –®–∞–±–ª–æ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<template id="userTemplate">
    <div class="deal-item">
        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
            <div>
                <div style="font-weight: bold;" data-field="name"></div>
                <div style="font-size: 12px; color: var(--tg-theme-hint-color);" data-field="telegram_id"></div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 12px; color: var(--tg-theme-hint-color);" data-field="balances"></div>
                <div style="font-size: 12px; color: #28a745;" data-field="deals"></div>
            </div>
        </div>
        
        <div style="display: flex; gap: 4px; margin-top: 8px;">
            <button class="btn btn-secondary" style="flex: 1; padding: 6px; font-size: 12px;" 
                    onclick="quickAddBalance(this)" data-field="quick_balance">
                üí∞ +100‚≠ê
            </button>
            <button class="btn btn-secondary" style="flex: 1; padding: 6px; font-size: 12px;" 
                    onclick="quickAddDeals(this)" data-field="quick_deals">
                üìà +10 —Å–¥–µ–ª–æ–∫
            </button>
            <button class="btn btn-secondary" style="flex: 1; padding: 6px; font-size: 12px;" 
                    onclick="resetUser(this)" data-field="reset">
                üîÑ –°–±—Ä–æ—Å
            </button>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadUsers();
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ Telegram
    if (window.telegramWebApp) {
        window.telegramWebApp.MainButton.setText('–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
        window.telegramWebApp.MainButton.onClick(() => {
            loadStats();
            loadUsers();
        });
        window.telegramWebApp.MainButton.show();
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º
    document.getElementById('addBalanceForm').addEventListener('submit', handleAddBalance);
    document.getElementById('updateDealsForm').addEventListener('submit', handleUpdateDeals);
});

function loadStats() {
    fetch('/api/admin/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderStats(data.stats);
            } else {
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
            }
        })
        .catch(error => {
            showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        });
}

function renderStats(stats) {
    const container = document.getElementById('statsContainer');
    const template = document.getElementById('statsTemplate');
    const element = template.content.cloneNode(true);
    
    element.querySelector('[data-field="total_users"]').textContent = stats.total_users;
    element.querySelector('[data-field="total_deals"]').textContent = stats.total_deals;
    element.querySelector('[data-field="total_stars"]').textContent = `‚≠ê ${stats.total_stars}`;
    element.querySelector('[data-field="total_rub"]').textContent = `‚ÇΩ ${stats.total_rub}`;
    
    container.innerHTML = '';
    container.appendChild(element);
}

function loadUsers() {
    fetch('/api/admin/users')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderUsers(data.users);
            } else {
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            }
        })
        .catch(error => {
            showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        });
}

function renderUsers(users) {
    const container = document.getElementById('usersContainer');
    
    if (users.length === 0) {
        container.innerHTML = '<div class="text-center" style="padding: 20px; color: var(--tg-theme-hint-color);">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</div>';
        return;
    }
    
    container.innerHTML = '';
    
    users.forEach(user => {
        const template = document.getElementById('userTemplate');
        const element = template.content.cloneNode(true);
        
        const name = user.first_name || user.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
        element.querySelector('[data-field="name"]').textContent = name;
        element.querySelector('[data-field="telegram_id"]').textContent = `ID: ${user.telegram_id}`;
        element.querySelector('[data-field="balances"]').textContent = `‚≠ê${user.balance_stars} | ‚ÇΩ${user.balance_rub}`;
        element.querySelector('[data-field="deals"]').textContent = `${user.successful_deals} —Å–¥–µ–ª–æ–∫`;
        
        // –î–æ–±–∞–≤–ª—è–µ–º telegram_id –∫ –∫–Ω–æ–ø–∫–∞–º
        const buttons = element.querySelectorAll('button[data-field]');
        buttons.forEach(btn => {
            btn.setAttribute('data-telegram-id', user.telegram_id);
        });
        
        container.appendChild(element);
    });
}

function showAddBalanceForm() {
    document.getElementById('addBalanceModal').classList.remove('hidden');
}

function hideAddBalanceForm() {
    document.getElementById('addBalanceModal').classList.add('hidden');
    document.getElementById('addBalanceForm').reset();
}

function showUpdateDealsForm() {
    document.getElementById('updateDealsModal').classList.remove('hidden');
}

function hideUpdateDealsForm() {
    document.getElementById('updateDealsModal').classList.add('hidden');
    document.getElementById('updateDealsForm').reset();
}

function handleAddBalance(e) {
    e.preventDefault();
    
    const formData = {
        telegram_id: document.getElementById('balanceUserId').value,
        amount: document.getElementById('balanceAmount').value,
        currency: document.getElementById('balanceCurrency').value
    };
    
    fetch('/api/admin/add_balance', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('–ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω!');
            hideAddBalanceForm();
            loadStats();
            loadUsers();
        } else {
            showAlert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    })
    .catch(error => {
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
    });
}

function handleUpdateDeals(e) {
    e.preventDefault();
    
    const formData = {
        telegram_id: document.getElementById('dealsUserId').value,
        deals_count: document.getElementById('dealsCount').value
    };
    
    fetch('/api/admin/update_deals', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!');
            hideUpdateDealsForm();
            loadStats();
            loadUsers();
        } else {
            showAlert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    })
    .catch(error => {
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
    });
}

function quickAddBalance(button) {
    const telegramId = button.getAttribute('data-telegram-id');
    
    const formData = {
        telegram_id: telegramId,
        amount: 100,
        currency: 'stars'
    };
    
    fetch('/api/admin/add_balance', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('–î–æ–±–∞–≤–ª–µ–Ω–æ 100 –∑–≤–µ–∑–¥!');
            loadStats();
            loadUsers();
        } else {
            showAlert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    });
}

function quickAddDeals(button) {
    const telegramId = button.getAttribute('data-telegram-id');
    
    // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫
    fetch('/api/admin/users')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const user = data.users.find(u => u.telegram_id === telegramId);
                const currentDeals = user ? user.successful_deals : 0;
                
                const formData = {
                    telegram_id: telegramId,
                    deals_count: currentDeals + 10
                };
                
                return fetch('/api/admin/update_deals', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('–î–æ–±–∞–≤–ª–µ–Ω–æ 10 —Å–¥–µ–ª–æ–∫!');
                loadStats();
                loadUsers();
            } else {
                showAlert('–û—à–∏–±–∫–∞: ' + data.message);
            }
        });
}

function resetUser(button) {
    const telegramId = button.getAttribute('data-telegram-id');
    
    confirmAction('–°–±—Ä–æ—Å–∏—Ç—å –±–∞–ª–∞–Ω—Å –∏ —Å–¥–µ–ª–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?', (confirmed) => {
        if (confirmed) {
            fetch('/api/admin/reset_balance', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({telegram_id: telegramId})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–±—Ä–æ—à–µ–Ω—ã!');
                    loadStats();
                    loadUsers();
                } else {
                    showAlert('–û—à–∏–±–∫–∞: ' + data.message);
                }
            });
        }
    });
}

function refreshUsers() {
    loadStats();
    loadUsers();
    showAlert('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
}
</script>
{% endblock %}